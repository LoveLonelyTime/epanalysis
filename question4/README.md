# 任务四

## 任务需求

根据电力客户数据编码，建立电力用户用电模型，对企业电力营销和调度进行决策支撑，需要模型参数优化与评估分析。

## 实现原理

### 数据处理

我们收集了某地区2年以来近1000家企业的每日用电量统计表，通过不放回抽样创建训练和验证数据。

具体方法如下：

1. 每个企业总共有609天的数据，然后遍历整个数据表，将不足609天的企业将其剔除，作为数据清洗。
2. 我们假设创建30000家电力企业，每家企业随机的从1483家企业中抽取500家用电企业企业，作为当前电力企业的500家客户。

对于电力客户数据编码，我们通过简单的直方图数量分析，我们发现，大部分用电用户都在10到1000这个范围分布，我们遵循正态分布原理，我们将从最小值到最大值按照20%，20%，20%，20%，20%，切分出5个等长区间。其中10到1000这个区间占中间的60%。我们将这四个区间内的用户编码成5种客户类型：

|客户类型|用电量|代表类型|
|---|---|---|
|A类|用电量在1到13|低电量用户，代表个人等微型用电用户|
|B类|用电量在13到153|中电量用户，代表家庭、私营店铺等小型用电用户|
|C类|用电量在153到401|高电量用电用户，代表学校、小型企业等用电用户|
|D类|用电量在401到1118|超高电量用户，代表普通工厂等用户用户|
|E类|用电量在1118到1310016|大型用电量用户，代表重型工厂等用电用户|

最终我们得到30000条数据，每条数据包括609个元素，每个元素记录了每天5个类型用户的数量。

### 模型搭建

我们的目标是通过每天的5种用户类型的数量去预测每天的生产电量，通过连续生成609天，得到2年内的营销方案。

通过连续尝试、调参，我们最终确定一种最优的DNN模型：

|NN层|输入特征大小|输出特征大小|描述|
|---|---|---|---|
|1|3045|4096|输入层|
|2|4096|2048|隐藏层|
|3|2048|1024|隐藏层|
|4|1024|609|输出层|

显然，输入层作为数据扁平化，将 $ 609 \times 5 = 3045 $ 个特征向量中的元素进行输入。通过2个隐藏层，最终输出层输出609天的每天的营销数据。

特别的，我们中间的激活函数使用ReLU激活函数。

### 训练方法

我们采用二八原则，数据的前80%作为训练数据，后20%作为测试数据。

训练中使用 MSELoss 作为损失函数，并跟踪 $ R^2 $ 指数。持续进行训练得到满意结果。

## 任务总结

### 技术路线

本任务使用 Python + PyTorch 作为基本框架使用。

数据集来自某地区统计数据，合法使用。

### 文件说明

|文件名|描述|
|---|---|
|dproc.ipynb|展示数据处理|
|dsets.py|数据集封装|
|logconf.py|日志管理|
|model_weights.pth|模型参数文件|
|model.py|模型封装|
|pred.ipynb|展示验证模型正确性|
|run-training.ipynb|展示训练模型|
|training.py|训练器封装|
|data/|数据集，以*.7z结尾的要先解压才能使用|
|runs|tensorboard日志|
|README.md|该任务文档|

### 模型使用方法

详见 [pred.ipynb](./pred.ipynb) 文件。

### 模型评估

最终评估训练结果为，验证集平均 $ R^2 = 0.65 $ ，实际预测 $ R^2 = 0.82 $ ，详见 [pred.ipynb](./pred.ipynb) ，或者执行 `tensorboard --logdir=runs` 命令，查看模型评估结果。
